<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Voucher Entry - Tally Style</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
        }
        .page-content {
            padding: 20px;
        }
        .voucher-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .voucher-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .voucher-title {
            color: #2c3e50;
            margin: 0;
        }
        .voucher-info {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .form-row {
            display: flex;
            gap: 20px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .entries-section {
            margin-top: 30px;
        }
        .entries-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .entries-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .entries-table th,
        .entries-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        .entries-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .entries-table input,
        .entries-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .amount-input {
            text-align: right;
        }
        .btn-add {
            background-color: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-remove {
            background-color: #dc3545;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .totals-section {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        .total-item {
            text-align: center;
        }
        .total-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        .total-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        .balance-check {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        .balance-ok {
            background-color: #d4edda;
            color: #155724;
        }
        .balance-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .btn-save {
            background-color: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
        }
        .btn-save:hover {
            background-color: #0056b3;
        }
        .btn-save:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .required {
            color: red;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-logo">Cloth Shop</div>
        <ul class="navbar-links">
            <li><a th:href="@{/}">Home</a></li>
            <li th:if="${session.user != null and session.user.type == 'Admin'}">
                <a th:href="@{/admin}">Admin</a>
            </li>
            <li><a th:href="@{/shop}">Shop</a></li>
            <li th:if="${session.user != null}">
                <a th:href="@{/orders}">Orders</a>
            </li>
            <li><a href="#">Services</a></li>
            <li><a href="#">Pricing</a></li>
            <li><a href="#">About Us</a></li>
            <li><a href="#">Contact Us</a></li>
            
            <!-- Dynamic Login/Logout -->
            <li th:if="${session.user == null}"><a th:href="@{/login}">Login</a></li>
            <li th:if="${session.user != null}"><a th:href="@{/logout}">Logout</a></li>
        </ul>
    </nav>

    <div class="page-content">
        <div class="voucher-container">
            <a th:href="@{/admin}" class="back-link">← Back to Admin Panel</a>
            
            <div class="voucher-header">
                <h1 class="voucher-title">Voucher Entry</h1>
                <div>
                    <a th:href="@{/admin/accounts}" class="btn-add">Manage Accounts</a>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div th:if="${success}" class="alert alert-success" style="background: #d4edda; color: #155724; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #c3e6cb;">
                <strong>Success!</strong> <span th:text="${success}"></span>
            </div>
            <div th:if="${error}" class="alert alert-error" style="background: #f8d7da; color: #721c24; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #f5c6cb;">
                <strong>Error!</strong> <span th:text="${error}"></span>
            </div>

            <form th:action="@{/admin/vouchers/save}" method="post" id="voucherForm" onsubmit="return validateAndSubmit()">
                <!-- Voucher Header Information -->
                <div class="voucher-info">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">Date <span class="required">*</span></label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="type">Voucher Type <span class="required">*</span></label>
                            <select id="type" name="type" required>
                                <option value="">Select Type</option>
                                <option value="Payment">Payment</option>
                                <option value="Receipt">Receipt</option>
                                <option value="Sales">Sales</option>
                                <option value="Purchase">Purchase</option>
                                <option value="Journal">Journal</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="narration">Narration <span class="required">*</span></label>
                    <input type="text" id="narration" name="narration" required 
                           placeholder="Enter transaction description">
                </div>

                <!-- Voucher Entries Section -->
                <div class="entries-section">
                <div class="entries-header">
                    <h3>Voucher Entries</h3>
                    <button type="button" class="btn-add" onclick="addEntry()">Add Entry</button>
                </div>
                
                <!-- Debug Section -->
                <div id="debugInfo" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px;">
                    <strong>Debug Info:</strong><br>
                    <span id="accountCount">Loading...</span><br>
                    <span id="accountList">Loading...</span><br>
                    <button onclick="testAJAX()" style="margin: 5px 0; padding: 5px 10px;">Test AJAX Load</button>
                    <button onclick="addEntry()" style="margin: 5px 0; padding: 5px 10px;">Add Entry Manually</button>
                    <button onclick="debugFormData()" style="margin: 5px 0; padding: 5px 10px;">Debug Form Data</button>
                    <button onclick="fixFormFieldNames()" style="margin: 5px 0; padding: 5px 10px;">Fix Form Names</button>
                </div>

                    <table class="entries-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="width: 35%;">Account <span class="required">*</span></th>
                                <th style="width: 15%;">Debit Amount</th>
                                <th style="width: 15%;">Credit Amount</th>
                                <th style="width: 20%;">Description</th>
                                <th style="width: 10%;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="entriesTableBody">
                            <!-- Entries will be added dynamically -->
                        </tbody>
                    </table>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="total-item">
                            <div class="total-label">Total Debit</div>
                            <div class="total-value" id="totalDebit">₹ 0.00</div>
                        </div>
                        <div class="total-item">
                            <div class="total-label">Total Credit</div>
                            <div class="total-value" id="totalCredit">₹ 0.00</div>
                        </div>
                        <div class="total-item">
                            <div class="total-label">Difference</div>
                            <div class="total-value" id="difference">₹ 0.00</div>
                        </div>
                    </div>

                    <div id="balanceCheck" class="balance-check" style="display: none;">
                        <!-- Balance check message will appear here -->
                    </div>
                </div>

                <button type="submit" class="btn-save" id="saveButton" disabled>Save Voucher</button>
            </form>
        </div>
    </div>

    <script>
        let entryCount = 0;
        
        // Try multiple ways to get accounts data
        let accounts = [];
        
        // Method 1: Try Thymeleaf
        try {
            const thymeleafAccounts = /*[[${accounts}]]*/ [];
            if (thymeleafAccounts && Array.isArray(thymeleafAccounts)) {
                accounts = thymeleafAccounts;
                console.log('Accounts loaded via Thymeleaf:', accounts.length);
            }
        } catch (e) {
            console.log('Thymeleaf method failed:', e);
        }
        
        // Function to load accounts via AJAX
        function loadAccountsViaAJAX() {
            console.log('Loading accounts via AJAX...');
            fetch('/admin/vouchers/simple-accounts')
                .then(response => {
                    console.log('AJAX response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Accounts loaded via AJAX:', data);
                    console.log('Number of accounts from AJAX:', data.length);
                    accounts = data;
                    window.accounts = data;
                    // Update debug info
                    document.getElementById('accountCount').textContent = `Account count: ${data.length} (from AJAX)`;
                    document.getElementById('accountList').textContent = `Accounts: ${data.map(acc => acc.name).join(', ')}`;
                    
                    // Refresh the entries if they exist
                    const existingEntries = document.querySelectorAll('#entriesTableBody tr');
                    existingEntries.forEach(row => {
                        const select = row.querySelector('select[name*=".accountId"]');
                        if (select) {
                            updateSelectOptions(select);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading accounts via AJAX:', error);
                    document.getElementById('accountCount').textContent = `AJAX Error: ${error.message}`;
                });
        }
        
        // Function to update select options
        function updateSelectOptions(selectElement) {
            const currentValue = selectElement.value;
            const accountsToUse = window.accounts || accounts || [];
            
            let accountOptions = '';
            if (accountsToUse && Array.isArray(accountsToUse) && accountsToUse.length > 0) {
                accountOptions = accountsToUse.map(acc => {
                    const displayName = (acc.parentName && acc.parentName !== acc.name) ? acc.parentName + ' - ' + acc.name : acc.name;
                    return `<option value="${acc.id}" data-type="${acc.type || ''}" data-parent="${acc.parentName || ''}">
                                ${displayName} (${acc.type || ''})
                            </option>`;
                }).join('');
            } else {
                accountOptions = '<option value="">No accounts available</option>';
            }
            
            selectElement.innerHTML = '<option value="">Select Account</option>' + accountOptions;
            selectElement.value = currentValue; // Restore previous selection
        }
        
        // Method 2: Always try AJAX to get real accounts
        console.log('Attempting to load real accounts via AJAX...');
        loadAccountsViaAJAX();
        
        // Method 3: Hardcoded test accounts as fallback
        setTimeout(() => {
            if (!window.accounts || window.accounts.length === 0) {
                console.log('AJAX failed, using hardcoded test accounts...');
                accounts = [
                    {id: 1, name: 'ASSETS', type: 'ASSET'},
                    {id: 2, name: 'LIABILITIES', type: 'LIABILITY'},
                    {id: 3, name: 'INCOME', type: 'INCOME'},
                    {id: 4, name: 'Cash', type: 'ASSET'},
                    {id: 5, name: 'Bank Account', type: 'ASSET'}
                ];
                window.accounts = accounts;
                // Update debug info
                document.getElementById('accountCount').textContent = `Account count: ${accounts.length} (hardcoded)`;
                document.getElementById('accountList').textContent = `Accounts: ${accounts.map(acc => acc.name).join(', ')}`;
            }
        }, 2000); // Wait 2 seconds for AJAX to complete
        
        console.log('Accounts loaded:', accounts);
        console.log('Number of accounts:', accounts.length);
        console.log('Accounts type:', typeof accounts);
        console.log('Is accounts array?', Array.isArray(accounts));
        
        // Debug: Log each account
        if (accounts && accounts.length > 0) {
            accounts.forEach((acc, index) => {
                console.log(`Account ${index}:`, acc);
            });
        } else {
            console.error('No accounts found or accounts is not an array');
        }

        function addEntry() {
            entryCount++;
            const tbody = document.getElementById('entriesTableBody');
            const row = document.createElement('tr');
            row.setAttribute('data-entry-index', entryCount - 1);
            
            const accountsToUse = (accounts && accounts.length > 0) ? accounts : (window.accounts || []);
            console.log('Adding entry, accounts available:', accountsToUse);
            
            row.innerHTML = `
                <td>${entryCount}</td>
                <td>
                    <select name="entries[${entryCount-1}].accountId" required onchange="updateAccountInfo(this)">
                        <option value="">Select Account</option>
                    </select>
                </td>
                <td>
                    <input type="number" name="entries[${entryCount-1}].debit" step="0.01" min="0" 
                           class="amount-input" onchange="calculateTotals()" oninput="calculateTotals()" 
                           placeholder="0.00">
                </td>
                <td>
                    <input type="number" name="entries[${entryCount-1}].credit" step="0.01" min="0" 
                           class="amount-input" onchange="calculateTotals()" oninput="calculateTotals()" 
                           placeholder="0.00">
                </td>
                <td>
                    <input type="text" name="entries[${entryCount-1}].description" placeholder="Entry description">
                </td>
                <td>
                    <button type="button" class="btn-remove" onclick="removeEntry(this)">Remove</button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Update the select options for the new row
            const select = row.querySelector('select[name*=".accountId"]');
            if (select) {
                updateSelectOptions(select);
            }
            
            calculateTotals();
        }

        function removeEntry(button) {
            button.closest('tr').remove();
            reindexEntries();
            calculateTotals();
        }

        function reindexEntries() {
            const rows = document.querySelectorAll('#entriesTableBody tr');
            console.log('Reindexing entries, found ' + rows.length + ' rows');
            
            rows.forEach((row, index) => {
                // Update row number
                const rowNumberCell = row.querySelector('td:first-child');
                if (rowNumberCell) {
                    rowNumberCell.textContent = index + 1;
                }
                
                // Update form field names
                const accountSelect = row.querySelector('select[name*=".accountId"]');
                const debitInput = row.querySelector('input[name*=".debit"]');
                const creditInput = row.querySelector('input[name*=".credit"]');
                const descriptionInput = row.querySelector('input[name*=".description"]');
                
                if (accountSelect) {
                    accountSelect.name = `entries[${index}].accountId`;
                    console.log('Updated account select name to: ' + accountSelect.name);
                }
                if (debitInput) {
                    debitInput.name = `entries[${index}].debit`;
                    console.log('Updated debit input name to: ' + debitInput.name);
                }
                if (creditInput) {
                    creditInput.name = `entries[${index}].credit`;
                    console.log('Updated credit input name to: ' + creditInput.name);
                }
                if (descriptionInput) {
                    descriptionInput.name = `entries[${index}].description`;
                    console.log('Updated description input name to: ' + descriptionInput.name);
                }
                
                // Update data attribute
                row.setAttribute('data-entry-index', index);
            });
            
            // Update entry count
            entryCount = rows.length;
            console.log('Entry count updated to: ' + entryCount);
        }

        function updateAccountInfo(select) {
            const option = select.options[select.selectedIndex];
            const accountType = option.getAttribute('data-type');
            const parentName = option.getAttribute('data-parent');
            
            // You can add logic here to show account type or other info
            console.log('Selected account type:', accountType);
        }

        function calculateTotals() {
            let totalDebit = 0;
            let totalCredit = 0;

            const rows = document.querySelectorAll('#entriesTableBody tr');
            rows.forEach(row => {
                const debitInput = row.querySelector('input[name*=".debit"]');
                const creditInput = row.querySelector('input[name*=".credit"]');
                
                if (debitInput && debitInput.value) {
                    totalDebit += parseFloat(debitInput.value) || 0;
                }
                if (creditInput && creditInput.value) {
                    totalCredit += parseFloat(creditInput.value) || 0;
                }
            });

            document.getElementById('totalDebit').textContent = '₹ ' + totalDebit.toFixed(2);
            document.getElementById('totalCredit').textContent = '₹ ' + totalCredit.toFixed(2);
            
            const difference = totalDebit - totalCredit;
            document.getElementById('difference').textContent = '₹ ' + difference.toFixed(2);

            // Check balance
            const balanceCheck = document.getElementById('balanceCheck');
            const saveButton = document.getElementById('saveButton');
            
            if (Math.abs(difference) < 0.01) { // Accounts are balanced
                balanceCheck.textContent = '✓ Voucher is balanced';
                balanceCheck.className = 'balance-check balance-ok';
                balanceCheck.style.display = 'block';
                saveButton.disabled = false;
            } else {
                balanceCheck.textContent = '⚠ Voucher is not balanced. Difference: ₹ ' + difference.toFixed(2);
                balanceCheck.className = 'balance-check balance-error';
                balanceCheck.style.display = 'block';
                saveButton.disabled = true;
            }
        }


        // Test AJAX function
        function testAJAX() {
            console.log('Testing AJAX...');
            loadAccountsViaAJAX();
        }

        // Debug function to check form data
        function debugFormData() {
            console.log('=== FORM DEBUG ===');
            const form = document.getElementById('voucherForm');
            const formData = new FormData(form);
            
            console.log('Form data entries:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            console.log('Form elements:');
            const elements = form.querySelectorAll('input, select, textarea');
            elements.forEach(el => {
                if (el.name) {
                    console.log(`${el.name}: ${el.value} (type: ${el.type})`);
                }
            });
        }

        // Force fix form field names
        function fixFormFieldNames() {
            console.log('Fixing form field names...');
            const rows = document.querySelectorAll('#entriesTableBody tr');
            console.log('Found ' + rows.length + ' rows to fix');
            
            rows.forEach((row, index) => {
                const accountSelect = row.querySelector('select');
                const debitInput = row.querySelector('input[name*="debit"]');
                const creditInput = row.querySelector('input[name*="credit"]');
                const descriptionInput = row.querySelector('input[name*="description"]');
                
                // Force set names
                if (accountSelect) {
                    accountSelect.name = `entries[${index}].accountId`;
                    console.log('Fixed account select name:', accountSelect.name);
                }
                if (debitInput) {
                    debitInput.name = `entries[${index}].debit`;
                    console.log('Fixed debit input name:', debitInput.name);
                }
                if (creditInput) {
                    creditInput.name = `entries[${index}].credit`;
                    console.log('Fixed credit input name:', creditInput.name);
                }
                if (descriptionInput) {
                    descriptionInput.name = `entries[${index}].description`;
                    console.log('Fixed description input name:', descriptionInput.name);
                }
            });
        }

        // Form validation and submission
        function validateAndSubmit() {
            console.log('Validating form submission...');
            
            // Reindex entries before submission
            reindexEntries();
            
            // Force fix all form field names
            fixFormFieldNames();
            
            // Debug: Check all form elements before submission
            console.log('=== PRE-SUBMISSION DEBUG ===');
            const form = document.getElementById('voucherForm');
            const allInputs = form.querySelectorAll('input, select, textarea');
            console.log('Total form elements found:', allInputs.length);
            
            allInputs.forEach((el, index) => {
                if (el.name) {
                    console.log(`Element ${index}: name="${el.name}", value="${el.value}", type="${el.type}"`);
                }
            });
            
            // Get all form data
            const formData = new FormData(document.getElementById('voucherForm'));
            console.log('Form data entries:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            // Check if voucher is balanced
            const totalDebit = parseFloat(document.getElementById('totalDebit').textContent.replace('₹ ', '').replace(',', ''));
            const totalCredit = parseFloat(document.getElementById('totalCredit').textContent.replace('₹ ', '').replace(',', ''));
            
            if (Math.abs(totalDebit - totalCredit) > 0.01) {
                alert('Voucher is not balanced. Please check your entries.');
                return false;
            }
            
            // Check if at least one entry has an account selected
            const accountSelects = document.querySelectorAll('select[name*=".accountId"]');
            let hasValidEntry = false;
            
            accountSelects.forEach(select => {
                if (select.value && select.value !== '') {
                    hasValidEntry = true;
                }
            });
            
            if (!hasValidEntry) {
                alert('Please select at least one account.');
                return false;
            }
            
            // Ensure all entries have proper values
            const rows = document.querySelectorAll('#entriesTableBody tr');
            let validEntries = 0;
            
            rows.forEach((row, index) => {
                const accountSelect = row.querySelector('select[name*=".accountId"]');
                const debitInput = row.querySelector('input[name*=".debit"]');
                const creditInput = row.querySelector('input[name*=".credit"]');
                
                if (accountSelect && accountSelect.value && accountSelect.value !== '') {
                    // Ensure debit and credit inputs have values (even if 0)
                    if (debitInput && !debitInput.value) {
                        debitInput.value = '0';
                    }
                    if (creditInput && !creditInput.value) {
                        creditInput.value = '0';
                    }
                    validEntries++;
                }
            });
            
            if (validEntries === 0) {
                alert('Please select at least one account.');
                return false;
            }
            
            console.log('Form validation passed, submitting...');
            return true;
        }

        // Add initial entries
        document.addEventListener('DOMContentLoaded', function() {
            // Update debug info
            const accountsToShow = (accounts && accounts.length > 0) ? accounts : (window.accounts || []);
            document.getElementById('accountCount').textContent = `Account count: ${accountsToShow.length}`;
            document.getElementById('accountList').textContent = `Accounts: ${accountsToShow.map(acc => acc.name).join(', ')}`;
            
            addEntry();
            addEntry();
            
            // Ensure all entries are properly indexed
            setTimeout(() => {
                reindexEntries();
            }, 100);
        });

        // Set today's date
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>