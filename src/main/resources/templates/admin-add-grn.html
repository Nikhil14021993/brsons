<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create GRN - Admin Panel</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .add-grn-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .back-link {
            display: inline-block;
            padding: 12px 24px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }
        
        .back-link:hover {
            background: #5a6268;
            color: white;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .page-header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .page-header p {
            margin: 10px 0 0 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #FF9800;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #FF9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .grn-items {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .items-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        
        .add-item-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }
        
        .add-item-btn:hover {
            background: #388E3C;
        }
        
        .item-row {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .item-number {
            font-weight: 600;
            color: #FF9800;
        }
        
        .remove-item-btn {
            background: #F44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s ease;
        }
        
        .remove-item-btn:hover {
            background: #D32F2F;
        }
        
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .totals-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .total-row:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: #FF9800;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #388E3C;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .messages {
            margin-bottom: 20px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .add-grn-container {
                padding: 15px;
            }
            
            .page-header h1 {
                font-size: 2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .item-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="add-grn-container">
        <!-- Back Link -->
        <a th:href="@{/admin/business/grn}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to GRN List
        </a>
        
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-truck-loading"></i> Create Goods Received Note</h1>
            <p>Record incoming goods from suppliers</p>
        </div>
        
        <!-- Messages -->
        <div class="messages" th:if="${successMessage != null and successMessage != '' or errorMessage != null and errorMessage != ''}">
            <div class="alert alert-success" th:if="${successMessage != null and successMessage != ''}" th:text="${successMessage}"></div>
            <div class="alert alert-error" th:if="${errorMessage != null and errorMessage != ''}" th:text="${errorMessage}"></div>
        </div>
        
        <!-- GRN Form -->
        <form id="grnForm" th:action="@{/admin/business/grn/new}" th:object="${grn}" method="post" class="form-container">
            
            <!-- Basic Information -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-info-circle"></i> Basic Information
                </h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="grnNumber">GRN Number</label>
                        <input type="text" id="grnNumber" name="grnNumber" 
                               th:field="*{grnNumber}" 
                               placeholder="Auto-generated if left empty">
                    </div>
                    
                    <div class="form-group">
                        <label for="receivedDate">Received Date</label>
                        <input type="date" id="receivedDate" name="receivedDate" 
                               th:field="*{receivedDate}">
                    </div>
                </div>
                
                                 <div class="form-row">
                     <div class="form-group">
                         <label for="purchaseOrder">Purchase Order <span style="color: #666; font-weight: normal;">(Optional - for direct GRN creation)</span></label>
                         <select id="purchaseOrder" name="purchaseOrder.id" onchange="onPurchaseOrderChange()">
                             <option value="">Create Direct GRN (No Purchase Order)</option>
                             <option th:each="po : ${purchaseOrders}" 
                                     th:if="${po.status != T(com.brsons.model.PurchaseOrder.POStatus).DRAFT and po.status != T(com.brsons.model.PurchaseOrder.POStatus).PENDING_APPROVAL and po.status != T(com.brsons.model.PurchaseOrder.POStatus).APPROVED}"
                                     th:value="${po.id}" 
                                     th:text="${po.poNumber + ' - ' + po.supplier.companyName + ' (' + po.status + ')'}">
                                 PO001 - Supplier Name
                             </option>
                         </select>
                         <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">
                             <i class="fas fa-info-circle"></i> You can create a GRN directly without a Purchase Order, or select an existing PO. 
                             Only Purchase Orders with status ORDERED, PARTIALLY_RECEIVED, or FULLY_RECEIVED are shown.
                             <span th:if="${#lists.isEmpty(purchaseOrders)}" style="color: #e74c3c; font-weight: bold;">
                                 <br>⚠️ No Purchase Orders available. You can still create a direct GRN by selecting a supplier below.
                             </span>
                         </small>
                     </div>
                     
                     <div class="form-group">
                         <label for="supplier">Supplier</label>
                         <select id="supplier" name="supplier.id" required>
                             <option value="">Select Supplier</option>
                             <option th:each="supplier : ${suppliers}" 
                                     th:value="${supplier.id}" 
                                     th:text="${supplier.companyName}">
                                 Supplier Name
                             </option>
                         </select>
                     </div>
                 </div>
            </div>
            
            <!-- Delivery Information -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-truck"></i> Delivery Information
                </h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="deliveryNoteNumber">Delivery Note Number</label>
                        <input type="text" id="deliveryNoteNumber" name="deliveryNoteNumber" 
                               th:field="*{deliveryNoteNumber}" 
                               placeholder="Supplier's delivery note number">
                    </div>
                    
                    <div class="form-group">
                        <label for="vehicleNumber">Vehicle Number</label>
                        <input type="text" id="vehicleNumber" name="vehicleNumber" 
                               th:field="*{vehicleNumber}" 
                               placeholder="Vehicle registration number">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="receivedBy">Received By</label>
                        <input type="text" id="receivedBy" name="receivedBy" 
                               th:field="*{receivedBy}" 
                               th:value="${user.name}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="inspectedBy">Inspected By</label>
                        <input type="text" id="inspectedBy" name="inspectedBy" 
                               th:field="*{inspectedBy}" 
                               placeholder="Quality inspector name">
                    </div>
                </div>
            </div>
            
            <!-- GRN Items -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-boxes"></i> GRN Items
                </h3>
                
                <div class="grn-items">
                                         <div class="items-header">
                         <h4 class="items-title">Items Received</h4>
                         <button type="button" class="add-item-btn" onclick="addItem()" id="addItemBtn">
                             <i class="fas fa-plus"></i> Add Item
                         </button>
                     </div>
                    
                    <div id="items-container">
                        <!-- Items will be added here dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Totals -->
            <div class="totals-section">
                <h4>Totals</h4>
                <div class="total-row">
                    <span>Subtotal (Accepted Qty × Unit Price):</span>
                    <span id="subtotal">₹0.00</span>
                </div>
                <div class="total-row">
                    <span>Discount Amount:</span>
                    <span id="discountAmount">₹0.00</span>
                </div>
                <div class="total-row">
                    <span>Net Amount (Subtotal - Discount):</span>
                    <span id="netAmount">₹0.00</span>
                </div>
                <!-- CGST/SGST Breakdown (for CGST_SGST tax type) -->
                <div class="total-row cgst-sgst-breakdown" style="display: none;">
                    <span>CGST Amount:</span>
                    <span id="cgstAmount">₹0.00</span>
                </div>
                <div class="total-row cgst-sgst-breakdown" style="display: none;">
                    <span>SGST Amount:</span>
                    <span id="sgstAmount">₹0.00</span>
                </div>
                <!-- IGST Breakdown (for IGST tax type) -->
                <div class="total-row igst-breakdown" style="display: none;">
                    <span>IGST Amount:</span>
                    <span id="igstAmount">₹0.00</span>
                </div>
                <!-- Fallback Tax Amount (for old tax structure) -->
                <div class="total-row fallback-tax-breakdown">
                    <span>Tax Amount:</span>
                    <span id="taxAmount">₹0.00</span>
                </div>
                <div class="total-row">
                    <span>Grand Total (Net + Tax):</span>
                    <span id="totalAmount">₹0.00</span>
                </div>
            </div>
            
            <!-- Additional Information -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-clipboard"></i> Additional Information
                </h3>
                
                <div class="form-group">
                    <label for="qualityRemarks">Quality Remarks</label>
                    <textarea id="qualityRemarks" name="qualityRemarks" 
                              th:field="*{qualityRemarks}" 
                              placeholder="Quality inspection notes and remarks"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="notes">General Notes</label>
                    <textarea id="notes" name="notes" 
                              th:field="*{notes}" 
                              placeholder="Additional notes and comments"></textarea>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="form-actions">
                <a th:href="@{/admin/business/grn}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Create GRN
                </button>
            </div>
        </form>
    </div>
    
         <script th:inline="javascript">
         function reindexItems() {
    const items = document.querySelectorAll('#items-container .item-row');
    items.forEach((item, idx) => {
        // update id
        item.id = `item-${idx+1}`;
        // update displayed number
        const num = item.querySelector('.item-number');
        if (num) num.textContent = `Item ${idx+1}`;

        // update each input/select name that contains grnItems[<num>]
        item.querySelectorAll('[name]').forEach(el => {
            const name = el.getAttribute('name');
            if (!name) return;
            // replace the first occurrence of grnItems[<digits>]
            const newName = name.replace(/grnItems\[\d+\]/, `grnItems[${idx}]`);
            el.setAttribute('name', newName);
        });
    });
}

// Reindex just before submit
document.getElementById('grnForm').addEventListener('submit', function (e) {
    reindexItems();
    // optional: run a final validation here
});

                             // Get purchase orders data from Thymeleaf
           const purchaseOrders = JSON.parse(/*[[${purchaseOrdersJson}]]*/ '[]');
           console.log('Purchase Orders loaded:', purchaseOrders); // Debug log
           console.log('Purchase Orders JSON string:', /*[[${purchaseOrdersJson}]]*/ '');
           console.log('Purchase Orders count:', purchaseOrders.length);
           console.log('Purchase Orders type:', typeof purchaseOrders);
           console.log('Purchase Orders is array:', Array.isArray(purchaseOrders));
           if (purchaseOrders.length > 0) {
               console.log('First PO:', purchaseOrders[0]);
               console.log('First PO items:', purchaseOrders[0].items);
           }
         let itemCounter = 0;
        
                 let selectedPO = null;
         
                                       function onPurchaseOrderChange() {
               const poSelect = document.getElementById('purchaseOrder');
               const supplierSelect = document.getElementById('supplier');
               const addItemBtn = document.getElementById('addItemBtn');
               const selectedPOId = poSelect.value;
               
               console.log('=== PO Selection Changed ===');
               console.log('PO Selection changed to:', selectedPOId);
               console.log('Available POs:', purchaseOrders);
               console.log('Available POs type:', typeof purchaseOrders);
               console.log('Available POs length:', purchaseOrders.length);
               
               if (selectedPOId) {
                   // Find the selected PO
                   selectedPO = purchaseOrders.find(po => po.id == selectedPOId);
                   console.log('Selected PO:', selectedPO);
                   console.log('Selected PO type:', typeof selectedPO);
                   
                   if (selectedPO) {
                       console.log('Selected PO items:', selectedPO.items);
                       console.log('Selected PO items type:', typeof selectedPO.items);
                       console.log('Selected PO items length:', selectedPO.items ? selectedPO.items.length : 'null');
                       
                       // Auto-select the supplier
                       supplierSelect.value = selectedPO.supplierId;
                       console.log('Auto-selected supplier:', selectedPO.supplierId);
                       
                       // Clear existing items and add new ones based on PO
                       clearItems();
                       console.log('Items cleared, now adding items from PO...');
                       addItemsFromPO(selectedPO);
                       
                       // Always show the Add Item button when a PO is selected
                       addItemBtn.style.display = 'inline-block';
                       console.log('Add Item button shown');
                       
                       // Update tax fields based on supplier tax type
                       updateTaxFieldsBasedOnSupplier();
                   }
               } else {
                   // Direct GRN creation (no PO selected)
                   selectedPO = null;
                   // Don't clear supplier selection - let user choose manually
                   clearItems();
                   // Show Add Item button for direct GRN creation
                   addItemBtn.style.display = 'inline-block';
                   console.log('Direct GRN mode - Add Item button shown, supplier selection available');
                   
                   // Update tax fields based on current supplier selection (if any)
                   updateTaxFieldsBasedOnSupplier();
               }
           }
         
         function clearItems() {
             const container = document.getElementById('items-container');
             container.innerHTML = '';
             itemCounter = 0;
         }
         
         function addItemsFromPO(po) {
             console.log('=== addItemsFromPO called ===');
             console.log('Adding items from PO:', po);
             console.log('PO items:', po.items);
             console.log('PO items length:', po.items ? po.items.length : 'null');
             
             if (po.items && po.items.length > 0) {
                 console.log('PO has items, processing them...');
                 po.items.forEach((poItem, index) => {
                     console.log('Processing PO item:', poItem);
                     console.log('Item details - ID:', poItem.productId, 'Name:', poItem.productName, 'Qty:', poItem.orderedQuantity);
                     itemCounter++;
                     const container = document.getElementById('items-container');
                     console.log('Container found:', container);
                     
                     const itemHtml = `
                         <div class="item-row" id="item-${itemCounter}">
                             <div class="item-header">
                                 <span class="item-number">Item ${itemCounter}</span>
                                 <button type="button" class="remove-item-btn" onclick="removeItem(${itemCounter})">
                                     <i class="fas fa-trash"></i> Remove
                                 </button>
                             </div>
                             <div class="item-grid">
                                 <div class="form-group">
                                     <label>Product</label>
                                     <select name="grnItems[${itemCounter-1}].product.id" required onchange="onProductChange(${itemCounter})">
                                         <option value="">Select Product</option>
                                         <option value="${poItem.productId}" selected>${poItem.productName}</option>
                                     </select>
                                 </div>
                                 <div class="form-group">
                                     <label>Ordered Quantity</label>
                                     <input type="number" name="grnItems[${itemCounter-1}].orderedQuantity" 
                                            min="0" step="1" placeholder="0" required 
                                            value="${poItem.orderedQuantity || 0}" readonly>
                                 </div>
                                 <div class="form-group">
                                     <label>Received Quantity</label>
                                     <input type="number" name="grnItems[${itemCounter-1}].receivedQuantity" 
                                            min="0" step="1" placeholder="0" required 
                                            value="${poItem.orderedQuantity || 0}"
                                            onchange="onReceivedQuantityChange(${itemCounter})">
                                 </div>
                                 <div class="form-group">
                                     <label>Accepted Quantity</label>
                                     <input type="number" name="grnItems[${itemCounter-1}].acceptedQuantity" 
                                            min="0" step="1" placeholder="0" required 
                                            value="${poItem.orderedQuantity || 0}"
                                            onchange="onAcceptedQuantityChange(${itemCounter})">
                                 </div>
                                 <div class="form-group">
                                     <label>Rejected Quantity</label>
                                     <input type="number" name="grnItems[${itemCounter-1}].rejectedQuantity" 
                                            min="0" step="1" placeholder="0" required 
                                            value="0"
                                            onchange="onRejectedQuantityChange(${itemCounter})">
                                 </div>
                                 <div class="form-group">
                                     <label>Unit Price</label>
                                     <input type="number" name="grnItems[${itemCounter-1}].unitPrice" 
                                            min="0" step="0.01" placeholder="0.00" required 
                                            value="${poItem.unitPrice || 0}" 
                                            onchange="calculateItemTotal(${itemCounter})">
                                 </div>
                                 <div class="form-group">
                                     <label>Discount %</label>
                                     <input type="number" name="grnItems[${itemCounter-1}].discountPercentage" 
                                            min="0" max="100" step="0.01" placeholder="0.00" 
                                            value="${poItem.discountPercentage || 0}"
                                            onchange="calculateItemTotal(${itemCounter})">
                                 </div>
                                 <!-- CGST/SGST Fields (for CGST_SGST tax type) -->
                                 <div class="form-group cgst-field" style="display: none;">
                                     <label>CGST %</label>
                                     <input type="number" name="grnItems[${itemCounter-1}].cgstPercentage" 
                                            min="0" max="100" step="0.01" placeholder="0.00" 
                                            value="0"
                                            onchange="calculateItemTotal(${itemCounter})">
                                 </div>
                                 <div class="form-group sgst-field" style="display: none;">
                                     <label>SGST %</label>
                                     <input type="number" name="grnItems[${itemCounter-1}].sgstPercentage" 
                                            min="0" max="100" step="0.01" placeholder="0.00" 
                                            value="0"
                                            onchange="calculateItemTotal(${itemCounter})">
                                 </div>
                                 <!-- IGST Field (for IGST tax type) -->
                                 <div class="form-group igst-field" style="display: none;">
                                     <label>IGST %</label>
                                     <input type="number" name="grnItems[${itemCounter-1}].igstPercentage" 
                                            min="0" max="100" step="0.01" placeholder="0.00" 
                                            value="0"
                                            onchange="calculateItemTotal(${itemCounter})">
                                 </div>
                                 <!-- Fallback Tax Field (for backward compatibility) -->
                                 <div class="form-group fallback-tax-field">
                                     <label>Tax %</label>
                                     <input type="number" name="grnItems[${itemCounter-1}].taxPercentage" 
                                            min="0" max="100" step="0.01" placeholder="0.00" 
                                            value="${poItem.taxPercentage || 0}"
                                            onchange="calculateItemTotal(${itemCounter})">
                                 </div>
                                 <div class="form-group">
                                     <label>Total Amount</label>
                                     <input type="number" name="grnItems[${itemCounter-1}].totalAmount" 
                                            readonly placeholder="0.00">
                                 </div>
                             </div>
                         </div>
                     `;
                     
                     console.log('About to insert HTML for item:', itemCounter);
                     container.insertAdjacentHTML('beforeend', itemHtml);
                     console.log('HTML inserted successfully for item:', itemCounter);
                 });
                 
                 // Calculate totals after adding items
                 calculateTotals();
                 console.log('Items added successfully, totals calculated');
                 
                 // Update tax fields for all items based on supplier tax type
                 updateTaxFieldsBasedOnSupplier();
             }
         }
         
         let allProducts = []; // Cache for all products
         
         function generateProductOptions() {
             console.log('generateProductOptions called, selectedPO:', selectedPO); // Debug log
             let options = '';
             
             // If a PO is selected, only show products from that PO
             if (selectedPO && selectedPO.items && selectedPO.items.length > 0) {
                 console.log('PO has items, generating product options');
                 selectedPO.items.forEach(poItem => {
                     console.log('Adding product option:', poItem.productName, 'ID:', poItem.productId);
                     options += `<option value="${poItem.productId}">${poItem.productName}</option>`;
                 });
             } else {
                 // For direct GRN creation, show all products
                 console.log('Direct GRN mode - using all products');
                 options = '<option value="">Select Product</option>';
                 allProducts.forEach(product => {
                     options += `<option value="${product.id}">${product.name} (${product.code})</option>`;
                 });
             }
             
             console.log('Generated options:', options); // Debug log
             return options;
         }
         
         // Fetch all products for direct GRN creation
         function fetchAllProducts() {
             if (allProducts.length === 0) {
                 fetch('/admin/business/grn/products')
                     .then(response => response.json())
                     .then(products => {
                         allProducts = products;
                         console.log('Fetched all products:', allProducts);
                     })
                     .catch(error => {
                         console.error('Error fetching products:', error);
                     });
             }
         }
        
                 function onProductChange(itemId) {
             const item = document.getElementById(`item-${itemId}`);
             const productSelect = item.querySelector('select[name*="product.id"]');
             const unitPriceInput = item.querySelector('input[name*="unitPrice"]');
             const discountInput = item.querySelector('input[name*="discountPercentage"]');
             const taxInput = item.querySelector('input[name*="taxPercentage"]');
             const orderedQtyInput = item.querySelector('input[name*="orderedQuantity"]');
             
             if (productSelect.value) {
                 if (selectedPO && selectedPO.items) {
                     // Find the PO item for this product
                     const poItem = selectedPO.items.find(poItem => poItem.productId == productSelect.value);
                     if (poItem) {
                         // Auto-fill all the PO details
                         unitPriceInput.value = poItem.unitPrice || 0;
                         discountInput.value = poItem.discountPercentage || 0;
                         taxInput.value = poItem.taxPercentage || 0;
                         orderedQtyInput.value = poItem.orderedQuantity || 0;
                         
                         // Make ordered quantity readonly since it comes from PO
                         orderedQtyInput.readOnly = true;
                         
                         calculateItemTotal(itemId);
                     }
                 } else {
                     // Direct GRN mode - find product in allProducts and set default price
                     const product = allProducts.find(p => p.id == productSelect.value);
                     if (product) {
                         unitPriceInput.value = product.price || 0;
                         discountInput.value = 0;
                         taxInput.value = 0;
                         orderedQtyInput.value = 0;
                         
                         // Set default values for quantities
                         const receivedQtyInput = item.querySelector('input[name*="receivedQuantity"]');
                         const acceptedQtyInput = item.querySelector('input[name*="acceptedQuantity"]');
                         const rejectedQtyInput = item.querySelector('input[name*="rejectedQuantity"]');
                         
                         receivedQtyInput.value = 0;
                         acceptedQtyInput.value = 0;
                         rejectedQtyInput.value = 0;
                         
                         // Make ordered quantity editable for direct GRN
                         orderedQtyInput.readOnly = false;
                         
                         calculateItemTotal(itemId);
                     }
                 }
             }
         }
        
                 function addItem() {
             console.log('addItem called, itemCounter:', itemCounter); // Debug log
             console.log('addItem called, selectedPO:', selectedPO); // Debug log
             
             // Allow adding items if a PO is selected OR if we're in direct GRN mode
             if (selectedPO && selectedPO.items && selectedPO.items.length > 0) {
                 // PO mode - items will be populated from PO
                 console.log('PO mode - adding items from PO');
             } else if (!selectedPO) {
                 // Direct GRN mode - allow adding any product
                 console.log('Direct GRN mode - adding items manually');
             } else {
                 console.log('No PO selected and not in direct GRN mode, cannot add item');
                 return;
             }
             
             itemCounter++;
             const container = document.getElementById('items-container');
             console.log('Container found:', container); // Debug log
             
             // Create a full item with all fields
             const itemHtml = `
                 <div class="item-row" id="item-${itemCounter}">
                     <div class="item-header">
                         <span class="item-number">Item ${itemCounter}</span>
                         <button type="button" class="remove-item-btn" onclick="removeItem(${itemCounter})">
                             <i class="fas fa-trash"></i> Remove
                         </button>
                     </div>
                     <div class="item-grid">
                         <div class="form-group">
                             <label>Product</label>
                             <select name="grnItems[${itemCounter-1}].product.id" required onchange="onProductChange(${itemCounter})">
                                 <option value="">Select Product</option>
                                 ${generateProductOptions()}
                             </select>
                         </div>
                         <div class="form-group">
                             <label>Ordered Quantity</label>
                             <input type="number" name="grnItems[${itemCounter-1}].orderedQuantity" 
                                    min="0" step="1" placeholder="0" required
                                    onchange="onOrderedQuantityChange(${itemCounter})">
                         </div>
                         <div class="form-group">
                             <label>Received Quantity</label>
                             <input type="number" name="grnItems[${itemCounter-1}].receivedQuantity" 
                                    min="0" step="1" placeholder="0" required 
                                    value="0"
                                    onchange="onReceivedQuantityChange(${itemCounter})">
                         </div>
                         <div class="form-group">
                             <label>Accepted Quantity</label>
                             <input type="number" name="grnItems[${itemCounter-1}].acceptedQuantity" 
                                    min="0" step="1" placeholder="0" required 
                                    value="0"
                                    onchange="onAcceptedQuantityChange(${itemCounter})">
                         </div>
                         <div class="form-group">
                             <label>Rejected Quantity</label>
                             <input type="number" name="grnItems[${itemCounter-1}].rejectedQuantity" 
                                    min="0" step="1" placeholder="0" required 
                                    value="0"
                                    onchange="onRejectedQuantityChange(${itemCounter})">
                         </div>
                         <div class="form-group">
                             <label>Unit Price</label>
                             <input type="number" name="grnItems[${itemCounter-1}].unitPrice" 
                                    min="0" step="0.01" placeholder="0.00" required 
                                    onchange="calculateItemTotal(${itemCounter})">
                         </div>
                         <div class="form-group">
                             <label>Discount %</label>
                             <input type="number" name="grnItems[${itemCounter-1}].discountPercentage" 
                                    min="0" max="100" step="0.01" placeholder="0.00" 
                                    onchange="calculateItemTotal(${itemCounter})">
                         </div>
                         <!-- CGST/SGST Fields (for CGST_SGST tax type) -->
                         <div class="form-group cgst-field" style="display: none;">
                             <label>CGST %</label>
                             <input type="number" name="grnItems[${itemCounter-1}].cgstPercentage" 
                                    min="0" max="100" step="0.01" placeholder="0.00" 
                                    onchange="calculateItemTotal(${itemCounter})">
                         </div>
                         <div class="form-group sgst-field" style="display: none;">
                             <label>SGST %</label>
                             <input type="number" name="grnItems[${itemCounter-1}].sgstPercentage" 
                                    min="0" max="100" step="0.01" placeholder="0.00" 
                                    onchange="calculateItemTotal(${itemCounter})">
                         </div>
                         <!-- IGST Field (for IGST tax type) -->
                         <div class="form-group igst-field" style="display: none;">
                             <label>IGST %</label>
                             <input type="number" name="grnItems[${itemCounter-1}].igstPercentage" 
                                    min="0" max="100" step="0.01" placeholder="0.00" 
                                    onchange="calculateItemTotal(${itemCounter})">
                         </div>
                         <!-- Fallback Tax Field (for backward compatibility) -->
                         <div class="form-group fallback-tax-field">
                             <label>Tax %</label>
                             <input type="number" name="grnItems[${itemCounter-1}].taxPercentage" 
                                    min="0" max="100" step="0.01" placeholder="0.00" 
                                    onchange="calculateItemTotal(${itemCounter})">
                         </div>
                         <div class="form-group">
                             <label>Total Amount</label>
                             <input type="number" name="grnItems[${itemCounter-1}].totalAmount" 
                                    readonly placeholder="0.00">
                         </div>
                     </div>
                 </div>
             `;
             
             console.log('About to insert HTML:', itemHtml); // Debug log
             container.insertAdjacentHTML('beforeend', itemHtml);
             console.log('HTML inserted successfully'); // Debug log
             
             // Update tax fields for the newly added item based on current supplier selection
             updateTaxFieldsBasedOnSupplier();
         }
        
        function removeItem(itemId) {
            const item = document.getElementById(`item-${itemId}`);
            item.remove();
            calculateTotals();
        }
        
        function calculateItemTotal(itemId) {
            const item = document.getElementById(`item-${itemId}`);
            const acceptedQty = parseFloat(item.querySelector('input[name*="acceptedQuantity"]').value) || 0;
            const unitPrice = parseFloat(item.querySelector('input[name*="unitPrice"]').value) || 0;
            const discountPercent = parseFloat(item.querySelector('input[name*="discountPercentage"]').value) || 0;
            
            // Calculate subtotal (Accepted Quantity * Unit Price)
            let subtotal = acceptedQty * unitPrice;
            
            // Calculate discount amount
            const discountAmount = subtotal * (discountPercent / 100);
            
            // Calculate net amount (subtotal - discount)
            const netAmount = subtotal - discountAmount;
            
            // Calculate tax based on which tax fields are visible
            let totalTax = 0;
            
            // Check if CGST/SGST fields are visible
            const cgstField = item.querySelector('.cgst-field');
            const sgstField = item.querySelector('.sgst-field');
            const igstField = item.querySelector('.igst-field');
            const fallbackField = item.querySelector('.fallback-tax-field');
            
            if (cgstField && cgstField.style.display !== 'none') {
                // CGST + SGST calculation
                const cgstPercent = parseFloat(item.querySelector('input[name*="cgstPercentage"]').value) || 0;
                const sgstPercent = parseFloat(item.querySelector('input[name*="sgstPercentage"]').value) || 0;
                
                const cgstAmount = netAmount * (cgstPercent / 100);
                const sgstAmount = netAmount * (sgstPercent / 100);
                
                totalTax = cgstAmount + sgstAmount;
            } else if (igstField && igstField.style.display !== 'none') {
                // IGST calculation
                const igstPercent = parseFloat(item.querySelector('input[name*="igstPercentage"]').value) || 0;
                totalTax = netAmount * (igstPercent / 100);
            } else if (fallbackField && fallbackField.style.display !== 'none') {
                // Fallback tax calculation
                const taxPercent = parseFloat(item.querySelector('input[name*="taxPercentage"]').value) || 0;
                totalTax = netAmount * (taxPercent / 100);
            }
            
            // Calculate grand total (net + tax)
            const grandTotal = netAmount + totalTax;
            
            // Update total amount field
            item.querySelector('input[name*="totalAmount"]').value = grandTotal.toFixed(2);
            
            calculateTotals();
        }
        
        function calculateTotals() {
            let totalSubtotal = 0;
            let totalDiscount = 0;
            let totalNet = 0;
            let totalCGST = 0;
            let totalSGST = 0;
            let totalIGST = 0;
            let totalTax = 0;
            let grandTotal = 0;
            
            // Calculate totals from all items
            const totalAmountInputs = document.querySelectorAll('input[name*="totalAmount"]');
            totalAmountInputs.forEach(input => {
                const item = input.closest('.item-row');
                const acceptedQty = parseFloat(item.querySelector('input[name*="acceptedQuantity"]').value) || 0;
                const unitPrice = parseFloat(item.querySelector('input[name*="unitPrice"]').value) || 0;
                const discountPercent = parseFloat(item.querySelector('input[name*="discountPercentage"]').value) || 0;
                
                // Calculate item subtotal (Accepted Quantity * Unit Price)
                const itemSubtotal = acceptedQty * unitPrice;
                
                // Calculate item discount amount
                const itemDiscountAmount = itemSubtotal * (discountPercent / 100);
                
                // Calculate item net amount (subtotal - discount)
                const itemNetAmount = itemSubtotal - itemDiscountAmount;
                
                // Calculate item tax amounts based on visible tax fields
                let itemCGST = 0;
                let itemSGST = 0;
                let itemIGST = 0;
                let itemTaxAmount = 0;
                
                const cgstField = item.querySelector('.cgst-field');
                const sgstField = item.querySelector('.sgst-field');
                const igstField = item.querySelector('.igst-field');
                const fallbackField = item.querySelector('.fallback-tax-field');
                
                if (cgstField && cgstField.style.display !== 'none' && sgstField && sgstField.style.display !== 'none') {
                    // CGST + SGST calculation
                    const cgstPercent = parseFloat(item.querySelector('input[name*="cgstPercentage"]').value) || 0;
                    const sgstPercent = parseFloat(item.querySelector('input[name*="sgstPercentage"]').value) || 0;
                    
                    itemCGST = itemNetAmount * (cgstPercent / 100);
                    itemSGST = itemNetAmount * (sgstPercent / 100);
                    itemTaxAmount = itemCGST + itemSGST;
                } else if (igstField && igstField.style.display !== 'none') {
                    // IGST calculation
                    const igstPercent = parseFloat(item.querySelector('input[name*="igstPercentage"]').value) || 0;
                    itemIGST = itemNetAmount * (igstPercent / 100);
                    itemTaxAmount = itemIGST;
                } else if (fallbackField && fallbackField.style.display !== 'none') {
                    // Fallback tax calculation
                    const taxPercent = parseFloat(item.querySelector('input[name*="taxPercentage"]').value) || 0;
                    itemTaxAmount = itemNetAmount * (taxPercent / 100);
                }
                
                // Add to totals
                totalSubtotal += itemSubtotal;
                totalDiscount += itemDiscountAmount;
                totalNet += itemNetAmount;
                totalCGST += itemCGST;
                totalSGST += itemSGST;
                totalIGST += itemIGST;
                totalTax += itemTaxAmount;
            });
            
            grandTotal = totalNet + totalTax;
            
            // Update display
            document.getElementById('subtotal').textContent = '₹' + totalSubtotal.toFixed(2);
            document.getElementById('discountAmount').textContent = '₹' + totalDiscount.toFixed(2);
            document.getElementById('netAmount').textContent = '₹' + totalNet.toFixed(2);
            document.getElementById('totalAmount').textContent = '₹' + grandTotal.toFixed(2);
            
            // Update specific tax breakdowns
            document.getElementById('cgstAmount').textContent = '₹' + totalCGST.toFixed(2);
            document.getElementById('sgstAmount').textContent = '₹' + totalSGST.toFixed(2);
            document.getElementById('igstAmount').textContent = '₹' + totalIGST.toFixed(2);
            document.getElementById('taxAmount').textContent = '₹' + totalTax.toFixed(2);
        }
        
        // Handle Ordered Quantity change - auto-set Received and Accepted quantities
        function onOrderedQuantityChange(itemId) {
            const item = document.getElementById(`item-${itemId}`);
            const orderedQtyInput = item.querySelector('input[name*="orderedQuantity"]');
            const receivedQtyInput = item.querySelector('input[name*="receivedQuantity"]');
            const acceptedQtyInput = item.querySelector('input[name*="acceptedQuantity"]');
            const rejectedQtyInput = item.querySelector('input[name*="rejectedQuantity"]');
            
            const orderedQty = parseFloat(orderedQtyInput.value) || 0;
            
            // Auto-set Received and Accepted quantities to Ordered Quantity
            receivedQtyInput.value = orderedQty;
            acceptedQtyInput.value = orderedQty;
            rejectedQtyInput.value = 0;
            
            // Update max attributes for validation
            receivedQtyInput.setAttribute('max', orderedQty);
            acceptedQtyInput.setAttribute('max', orderedQty);
            
            calculateItemTotal(itemId);
        }
        
        // Handle Received Quantity change - validate against Ordered Quantity
        function onReceivedQuantityChange(itemId) {
            const item = document.getElementById(`item-${itemId}`);
            const orderedQtyInput = item.querySelector('input[name*="orderedQuantity"]');
            const receivedQtyInput = item.querySelector('input[name*="receivedQuantity"]');
            const acceptedQtyInput = item.querySelector('input[name*="acceptedQuantity"]');
            const rejectedQtyInput = item.querySelector('input[name*="rejectedQuantity"]');
            
            const orderedQty = parseFloat(orderedQtyInput.value) || 0;
            const receivedQty = parseFloat(receivedQtyInput.value) || 0;
            
            // Validate: Received Quantity cannot exceed Ordered Quantity
            if (receivedQty > orderedQty) {
                alert(`Received Quantity (${receivedQty}) cannot exceed Ordered Quantity (${orderedQty})`);
                receivedQtyInput.value = orderedQty;
                receivedQty = orderedQty;
            }
            
            // Auto-adjust Accepted and Rejected quantities
            const currentAccepted = parseFloat(acceptedQtyInput.value) || 0;
            const currentRejected = parseFloat(rejectedQtyInput.value) || 0;
            const currentTotal = currentAccepted + currentRejected;
            
            if (currentTotal > receivedQty) {
                // If current total exceeds received, adjust proportionally
                if (receivedQty > 0) {
                    const ratio = receivedQty / currentTotal;
                    acceptedQtyInput.value = Math.round(currentAccepted * ratio);
                    rejectedQtyInput.value = Math.round(currentRejected * ratio);
                } else {
                    acceptedQtyInput.value = 0;
                    rejectedQtyInput.value = 0;
                }
            } else if (currentTotal < receivedQty) {
                // If current total is less than received, set accepted to received and rejected to 0
                acceptedQtyInput.value = receivedQty;
                rejectedQtyInput.value = 0;
            }
            
            // Update max attributes
            acceptedQtyInput.setAttribute('max', receivedQty);
            rejectedQtyInput.setAttribute('max', receivedQty);
            
            calculateItemTotal(itemId);
        }
        
        // Handle Accepted Quantity change - validate against Received Quantity
        function onAcceptedQuantityChange(itemId) {
            const item = document.getElementById(`item-${itemId}`);
            const receivedQtyInput = item.querySelector('input[name*="receivedQuantity"]');
            const acceptedQtyInput = item.querySelector('input[name*="acceptedQuantity"]');
            const rejectedQtyInput = item.querySelector('input[name*="rejectedQuantity"]');
            
            const receivedQty = parseFloat(receivedQtyInput.value) || 0;
            const acceptedQty = parseFloat(acceptedQtyInput.value) || 0;
            
            // Validate: Accepted Quantity cannot exceed Received Quantity
            if (acceptedQty > receivedQty) {
                alert(`Accepted Quantity (${acceptedQty}) cannot exceed Received Quantity (${receivedQty})`);
                acceptedQtyInput.value = receivedQty;
                acceptedQty = receivedQty;
            }
            
            // Auto-adjust Rejected Quantity to maintain: Accepted + Rejected = Received
            const rejectedQty = receivedQty - acceptedQty;
            rejectedQtyInput.value = rejectedQty;
            
            calculateItemTotal(itemId);
        }
        
        // Handle Rejected Quantity change - validate against Received Quantity
        function onRejectedQuantityChange(itemId) {
            const item = document.getElementById(`item-${itemId}`);
            const receivedQtyInput = item.querySelector('input[name*="receivedQuantity"]');
            const acceptedQtyInput = item.querySelector('input[name*="acceptedQuantity"]');
            const rejectedQtyInput = item.querySelector('input[name*="rejectedQuantity"]');
            
            const receivedQty = parseFloat(receivedQtyInput.value) || 0;
            const rejectedQty = parseFloat(rejectedQtyInput.value) || 0;
            
            // Validate: Rejected Quantity cannot exceed Received Quantity
            if (rejectedQty > receivedQty) {
                alert(`Rejected Quantity (${rejectedQty}) cannot exceed Received Quantity (${receivedQty})`);
                rejectedQtyInput.value = receivedQty;
                rejectedQty = receivedQty;
            }
            
            // Auto-adjust Accepted Quantity to maintain: Accepted + Rejected = Received
            const acceptedQty = receivedQty - rejectedQty;
            acceptedQtyInput.value = acceptedQty;
            
            calculateItemTotal(itemId);
        }
        
        // Update tax fields based on supplier tax type
        function updateTaxFieldsBasedOnSupplier() {
            const supplierSelect = document.getElementById('supplier');
            const selectedSupplierId = supplierSelect.value;
            
            if (selectedSupplierId) {
                // Fetch supplier tax type
                fetch(`/admin/business/suppliers/${selectedSupplierId}/tax-type`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.taxType) {
                            updateTaxFieldsDisplay(data.taxType);
                        } else {
                            console.error('Error fetching supplier tax type:', data.error);
                            // Show fallback tax field
                            updateTaxFieldsDisplay('FALLBACK');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching supplier tax type:', error);
                        // Show fallback tax field
                        updateTaxFieldsDisplay('FALLBACK');
                    });
            } else {
                // No supplier selected, show fallback tax field
                updateTaxFieldsDisplay('FALLBACK');
            }
        }
        
        function updateTaxFieldsDisplay(taxType) {
            const cgstFields = document.querySelectorAll('.cgst-field');
            const sgstFields = document.querySelectorAll('.sgst-field');
            const igstFields = document.querySelectorAll('.igst-field');
            const fallbackFields = document.querySelectorAll('.fallback-tax-field');
            
            // Hide all tax fields first
            cgstFields.forEach(field => field.style.display = 'none');
            sgstFields.forEach(field => field.style.display = 'none');
            igstFields.forEach(field => field.style.display = 'none');
            fallbackFields.forEach(field => field.style.display = 'none');
            
            // Update totals display based on tax type
            const cgstSgstBreakdown = document.querySelectorAll('.cgst-sgst-breakdown');
            const igstBreakdown = document.querySelectorAll('.igst-breakdown');
            const fallbackTaxBreakdown = document.querySelectorAll('.fallback-tax-breakdown');
            
            // Hide all totals breakdowns first
            cgstSgstBreakdown.forEach(field => field.style.display = 'none');
            igstBreakdown.forEach(field => field.style.display = 'none');
            fallbackTaxBreakdown.forEach(field => field.style.display = 'none');
            
            // Show relevant fields and totals based on tax type
            if (taxType === 'CGST_SGST') {
                cgstFields.forEach(field => field.style.display = 'block');
                sgstFields.forEach(field => field.style.display = 'block');
                cgstSgstBreakdown.forEach(field => field.style.display = 'flex');
                console.log('Showing CGST + SGST fields and totals');
            } else if (taxType === 'IGST') {
                igstFields.forEach(field => field.style.display = 'block');
                igstBreakdown.forEach(field => field.style.display = 'flex');
                console.log('Showing IGST fields and totals');
            } else {
                // Fallback to old tax field
                fallbackFields.forEach(field => field.style.display = 'block');
                fallbackTaxBreakdown.forEach(field => field.style.display = 'flex');
                console.log('Showing fallback tax field and totals');
            }
            
            // Recalculate totals to update the display
            calculateTotals();
        }
        
                 // Initialize page functionality
                   document.addEventListener('DOMContentLoaded', function() {
              console.log('DOM loaded, initializing GRN creation page'); // Debug log
              
              // Test if the page is working
              console.log('Testing page functionality...');
              console.log('Items container found:', document.getElementById('items-container'));
              
              // Fetch all products for direct GRN creation
              fetchAllProducts();
              
              // Show Add Item button by default for direct GRN creation
              const addItemBtn = document.getElementById('addItemBtn');
              if (addItemBtn) {
                  addItemBtn.style.display = 'inline-block';
              }
              
              // Add event listener for supplier dropdown
              const supplierSelect = document.getElementById('supplier');
              if (supplierSelect) {
                  supplierSelect.addEventListener('change', updateTaxFieldsBasedOnSupplier);
              }
              
              // Initialize tax fields display
              updateTaxFieldsBasedOnSupplier();
              
              console.log('Page initialization complete');
          });
    </script>
</body>
</html>
